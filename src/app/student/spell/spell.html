<div class="spell-container">
  <!-- Game Finished Screen -->
  @if (gameFinished) {
  <div class="game-finished">
    <h1>ğŸ‰ æ¸¸æˆç»“æŸ!</h1>
    <div class="score-board">
      <div class="score correct">
        <span class="label">æ­£ç¡®</span>
        <span class="value">{{ correctCount }}</span>
      </div>
      <div class="score wrong">
        <span class="label">é”™è¯¯</span>
        <span class="value">{{ wrongCount }}</span>
      </div>
      <div class="score total">
        <span class="label">æ­£ç¡®ç‡</span>
        <span class="value"
          >{{ words.length > 0 ? ((correctCount / words.length) * 100).toFixed(0) : 0 }}%</span
        >
      </div>
    </div>
    <button class="btn-restart" (click)="restart()">é‡æ–°å¼€å§‹</button>
  </div>
  }

  <!-- Start Game Screen with Word Selection -->
  @if (!gameStarted && !gameFinished) {
  <div class="game-start">
    <h1>ğŸ”¤ æ‹¼å†™æ¸¸æˆ</h1>
    <p>é€‰æ‹©è¦ç»ƒä¹ çš„å•å…ƒå’Œè¯¾æ—¶ï¼Œç„¶åå¼€å§‹æ¸¸æˆ</p>

    <div class="word-selection-card">
      <h3>ğŸ“š é€‰æ‹©å•è¯èŒƒå›´</h3>

      <mat-tree [dataSource]="dataSource" [treeControl]="treeControl" class="word-tree">
        <!-- Unit Node (Parent) -->
        <mat-nested-tree-node *matTreeNodeDef="let node; when: hasChild">
          <div class="tree-node unit-node">
            <button mat-icon-button matTreeNodeToggle>
              <mat-icon>
                {{ treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right' }}
              </mat-icon>
            </button>
            <mat-checkbox
              [checked]="isUnitSelected(node)"
              [indeterminate]="isUnitIndeterminate(node)"
              (change)="toggleUnit(node)"
            >
              {{ node.name }}
            </mat-checkbox>
            <span class="word-count-badge"> {{ getUnitWordCount(node) }} è¯ </span>
          </div>
          <div class="tree-children" [class.expanded]="treeControl.isExpanded(node)">
            <ng-container matTreeNodeOutlet></ng-container>
          </div>
        </mat-nested-tree-node>

        <!-- Lesson Node (Child) -->
        <mat-tree-node *matTreeNodeDef="let node" matTreeNodePadding>
          <div class="tree-node lesson-node">
            <span class="spacer"></span>
            <mat-checkbox
              [checked]="lessonSelection.isSelected(node)"
              (change)="toggleLesson(node)"
            >
              {{ node.name }}
            </mat-checkbox>
            <span class="word-count-badge small">{{ node.words.length }} è¯</span>
          </div>
        </mat-tree-node>
      </mat-tree>

      <div class="selection-summary">
        <span
          >å·²é€‰æ‹© <strong>{{ selectedWordCount }}</strong> ä¸ªå•è¯</span
        >
      </div>
    </div>

    <button class="btn-start" [disabled]="!canStartGame" (click)="startGame()">å¼€å§‹æ¸¸æˆ</button>
  </div>
  }

  <!-- Game Playing Screen -->
  @if (!gameFinished && gameStarted) {
  <div class="game-playing" cdkDropListGroup>
    <div class="progress-bar">
      <span>è¿›åº¦: {{ progress }}</span>
    </div>

    <div class="card">
      <!-- Current Word Display -->
      <div class="word-display">
        <!-- <h2>{{ currentWord }}</h2> -->
        <button class="audio-btn" (click)="wordAudio.play()">ğŸ”Š</button>
        <audio
          #wordAudio
          [src]="'https://dict.youdao.com/dictvoice?audio=' + currentWord + '&type=1'"
          autoplay
        ></audio>
      </div>

      <!-- Letter Slots (Drop Zone) -->
      <div class="letter-slots">
        @for(slot of letterSlots; track slot; let i = $index) {
        <div
          class="slot"
          [class.filled]="slot.filled"
          [class.correct]="showResult && userAnswer[i] === currentWord[i]"
          [class.wrong]="showResult && slot.filled && userAnswer[i] !== currentWord[i]"
          cdkDropList
          [cdkDropListData]="[slot.letter]"
          (cdkDropListDropped)="dropToSlot($event, i)"
          (click)="removeFromSlot(i)"
        >
          {{ slot.letter }}
        </div>
        }
      </div>

      <!-- Scrambled Letters (Drag Source) -->
      <div class="scrambled-letters" cdkDropList [cdkDropListData]="scrambledLetters">
        @for(letter of scrambledLetters; track letter) {
        <div class="letter" cdkDrag>
          {{ letter }}
          <div class="letter-placeholder" *cdkDragPlaceholder></div>
        </div>
        }
      </div>

      <!-- Result Display -->
      @if(showResult) {
      <div class="result">
        @if(isCorrect) {
        <span class="correct-msg">âœ… æ­£ç¡®!</span>
        <audio src="right.mp3" autoplay></audio>
        } @else {
        <span class="wrong-msg">âŒ é”™è¯¯! æ­£ç¡®ç­”æ¡ˆ: {{ currentWord }}</span>
        <audio src="wrong.mp3" autoplay></audio>
        }
      </div>
      }

      <!-- Action Buttons -->
      <div class="actions">
        @if(showResult) {
        <button class="btn-next" (click)="nextWord()">ä¸‹ä¸€ä¸ª</button>
        } @else {
        <button class="btn-confirm" [disabled]="!allSlotsFilled" (click)="confirm()">ç¡®è®¤</button>
        }
      </div>
    </div>

    <!-- Current Score -->
    <div class="current-score">
      <span class="correct">âœ… {{ correctCount }}</span>
      <span class="wrong">âŒ {{ wrongCount }}</span>
    </div>
  </div>
  }
</div>
